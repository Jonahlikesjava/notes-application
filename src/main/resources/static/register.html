<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.4/dist/jquery.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>
    <title>Register</title>
</head>
<body>
<div class="container mt-5">
    <h3 align="justify">Registration</h3>
    <div class="card" style="width: 55rem;">
        <div class="card-header text-center bg-info">
            <h3>Register</h3>
        </div>
        <div class="card-body">
            <form id="regForm">
                <div class="form-group mb-3">
                    <label for="username">Username</label>
                    <input type="text" class="form-control" id="username" required>
                </div>
                <div class="form-group mb-3">
                    <label for="email">Email</label>
                    <input type="email" class="form-control" id="email" required>
                </div>
                <div class="form-group mb-3">
                    <label for="password">Password</label>
                    <input type="password" class="form-control" id="password" required>
                </div>
                <div class="form-group mb-3">
                    <label for="confirm">Confirm Password</label>
                    <input type="password" class="form-control" id="confirm" required>
                </div>
                <button type="submit" class="btn btn-primary">Submit</button>
            </form>
            <p class="mt-3">Already have an account? <a href="/login.html">Log in</a></p>
            <div id="msg" class="mt-3"></div>
        </div>
    </div>
</div>
<script>
    const form = document.getElementById('regForm');
    const msg  = document.getElementById('msg');
    const strongPw = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[^A-Za-z0-9]).{8,}$/;
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      msg.textContent = '';
      const username = document.getElementById('username').value.trim();
      const email    = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value;
      const confirm  = document.getElementById('confirm').value;
      if (!strongPw.test(password)) {
        return show('Password must include uppercase, lowercase, digit, and special char (min 8).', true);
      }
      if (password !== confirm) {
        return show('Passwords do not match.', true);
      }
      try {
        const res = await fetch('/api/auth/register', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
          body: JSON.stringify({ username, email, password })
        });

        // Redirects user to log in page after successfully registering
        if (res.ok) {
           show('Account created! Redirecting to loginâ€¦');
           setTimeout(() => window.location.href = '/login.html', 1200);
        } else {
          let msgText = `HTTP ${res.status}`;
          try {
            const problem = await res.json();
            msgText = problem?.message || problem?.error || problem?.detail || msgText;
          } catch (_) {}
          show(msgText, true);
        }
      } catch {
        show('Network error. Is the API running on http://localhost:8080 ?', true);
      }
    });
    function show(text, isError = false) {
      msg.textContent = text;
      msg.style.color = isError ? '#b71c1c' : '#1b5e20';
    }
</script>
</body>
</html>
